<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—Å—ã–ª–∫–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="css/styles.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .form-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .form-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-group textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="file"] {
            padding: 0.5rem 0;
        }

        .file-list {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .file-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-tag .remove {
            cursor: pointer;
            color: #f44336;
            font-weight: bold;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-primary:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .stat-cards {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-value.pending {
            color: #f39c12;
        }

        .stat-value.sent {
            color: #27ae60;
        }

        .stat-value.failed {
            color: #e74c3c;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.sent {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .message-preview {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            font-size: 1.5rem;
            color: #3498db;
        }

        /* –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–∞–π–ª–æ–≤ */
        .library-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .library-header h3 {
            margin: 0;
            color: #333;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .library-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            position: relative;
        }

        .library-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .library-item.selected {
            border-color: #27ae60;
            background: #e8f5e9;
        }

        .library-item .preview {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-item .preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }

        .library-item .preview .icon {
            font-size: 3rem;
            color: #95a5a6;
        }

        .library-item .filename {
            font-size: 12px;
            margin-top: 0.5rem;
            word-break: break-word;
            color: #333;
        }

        .library-item .size {
            font-size: 11px;
            color: #999;
        }

        .library-item .actions {
            position: absolute;
            top: 4px;
            right: 4px;
            display: none;
            gap: 4px;
        }

        .library-item:hover .actions {
            display: flex;
        }

        .library-item .actions button {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .library-item .actions .edit-btn {
            background: #3498db;
            color: white;
        }

        .library-item .actions .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .library-item .checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h4 {
            margin-top: 0;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            color: #666;
        }

        .tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div class="container" x-data="broadcastsApp()" x-init="init()">
        <!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loading-overlay" x-show="sending" x-cloak>
            <div class="loading-spinner">–û—Ç–ø—Ä–∞–≤–∫–∞...</div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
        <div class="modal" x-show="editModal.show" x-cloak @click.self="editModal.show = false">
            <div class="modal-content">
                <h4>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª</h4>
                <div class="form-group">
                    <label>–ù–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞</label>
                    <input type="text" x-model="editModal.filename">
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" @click="editModal.show = false">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn-primary" @click="renameAttachment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="nav">
            <a href="users.html" class="nav-item">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="puzzles.html" class="nav-item">–ü–∞–∑–ª—ã</a>
            <a href="pieces.html" class="nav-item">–î–µ—Ç–∞–ª–∏</a>
            <a href="broadcasts.html" class="nav-item active">–†–∞—Å—Å—ã–ª–∫–∏</a>
            <a href="admins.html" class="nav-item">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</a>
            <a href="#" class="nav-item" @click.prevent="logout()">–í—ã—Ö–æ–¥</a>
        </div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1>–†–∞—Å—Å—ã–ª–∫–∏</h1>
            <div class="actions">
                <button @click="loadNotifications(); loadLibrary()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stat-cards">
            <div class="stat-card">
                <div class="stat-value pending" x-text="stats.pending"></div>
                <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
            </div>
            <div class="stat-card">
                <div class="stat-value sent" x-text="stats.sent"></div>
                <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value failed" x-text="stats.failed"></div>
                <div class="stat-label">–û—à–∏–±–∫–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="library.length"></div>
                <div class="stat-label">–§–∞–π–ª–æ–≤</div>
            </div>
        </div>

        <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
        <div class="library-section">
            <div class="library-header">
                <h3>üìÅ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–∞–π–ª–æ–≤</h3>
                <div>
                    <input type="file" id="libraryUpload" multiple @change="uploadToLibrary($event)" style="display:none">
                    <button class="btn-primary" @click="document.getElementById('libraryUpload').click()">
                        + –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                    </button>
                </div>
            </div>

            <div x-show="library.length === 0" style="text-align: center; padding: 2rem; color: #999;">
                –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö.
            </div>

            <div class="library-grid" x-show="library.length > 0">
                <template x-for="file in library" :key="file.id">
                    <div class="library-item" :class="{ 'selected': selectedLibraryFiles.includes(file.id) }"
                         @click="toggleLibraryFile(file.id)">
                        <input type="checkbox" class="checkbox"
                               :checked="selectedLibraryFiles.includes(file.id)"
                               @click.stop="toggleLibraryFile(file.id)">
                        <div class="actions" @click.stop>
                            <button class="edit-btn" @click="openEditModal(file)" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úé</button>
                            <button class="delete-btn" @click="deleteFromLibrary(file.id)" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </div>
                        <div class="preview">
                            <template x-if="isImage(file.mime_type)">
                                <img :src="'/api/admin/attachments/' + file.id + '/file'" :alt="file.filename">
                            </template>
                            <template x-if="!isImage(file.mime_type)">
                                <span class="icon">üìÑ</span>
                            </template>
                        </div>
                        <div class="filename" x-text="file.filename" :title="file.filename"></div>
                        <div class="size" x-text="formatSize(file.size)"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
        <div class="form-card">
            <h3>–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
            <div class="form-group">
                <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                <textarea id="message" x-model="newBroadcast.message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
            </div>
            <div class="form-group">
                <label for="group">–ì—Ä—É–ø–ø–∞ (–ø—É—Å—Ç–æ = –≤—Å–µ–º)</label>
                <select id="group" x-model="newBroadcast.group">
                    <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    <option value="–ù1">–ù1</option>
                    <option value="–ù2">–ù2</option>
                    <option value="–ù3">–ù3</option>
                    <option value="–ù4">–ù4</option>
                    <option value="–ù5">–ù5</option>
                    <option value="–ù6">–ù6</option>
                </select>
            </div>
            <div class="form-group">
                <label>–í–ª–æ–∂–µ–Ω–∏—è</label>

                <!-- –¢–∞–±—ã -->
                <div class="tabs">
                    <div class="tab" :class="{ 'active': attachTab === 'library' }" @click="attachTab = 'library'">
                        –ò–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (<span x-text="selectedLibraryFiles.length"></span>)
                    </div>
                    <div class="tab" :class="{ 'active': attachTab === 'upload' }" @click="attachTab = 'upload'">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ (<span x-text="newBroadcast.files.length"></span>)
                    </div>
                </div>

                <!-- –ò–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
                <div x-show="attachTab === 'library'" style="padding: 0.5rem 0;">
                    <template x-if="selectedLibraryFiles.length === 0">
                        <span style="color: #999;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤—ã—à–µ (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É)</span>
                    </template>
                    <div class="file-list" x-show="selectedLibraryFiles.length > 0">
                        <template x-for="fileId in selectedLibraryFiles" :key="fileId">
                            <span class="file-tag">
                                <span x-text="getLibraryFilename(fileId)"></span>
                                <span class="remove" @click="toggleLibraryFile(fileId)">&times;</span>
                            </span>
                        </template>
                    </div>
                </div>

                <!-- –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ -->
                <div x-show="attachTab === 'upload'">
                    <input type="file" multiple @change="handleFiles($event)" accept="image/*,.pdf,.doc,.docx">
                    <div class="file-list" x-show="newBroadcast.files.length > 0">
                        <template x-for="(file, index) in newBroadcast.files" :key="index">
                            <span class="file-tag">
                                <span x-text="file.name"></span>
                                <span class="remove" @click="removeFile(index)">&times;</span>
                            </span>
                        </template>
                    </div>
                </div>
            </div>
            <button class="btn-primary" @click="createBroadcast()" :disabled="!newBroadcast.message || sending">
                –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
            </button>
        </div>

        <!-- –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <div class="form-card">
            <h3>–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <div class="form-group">
                <label for="dm_telegram_id">Telegram ID</label>
                <input type="text" id="dm_telegram_id" x-model="directMessage.telegramId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
            </div>
            <div class="form-group">
                <label for="dm_message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                <textarea id="dm_message" x-model="directMessage.message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
            </div>
            <div class="form-group">
                <label>–í–ª–æ–∂–µ–Ω–∏—è –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</label>
                <div class="file-list" x-show="selectedDmFiles.length > 0">
                    <template x-for="fileId in selectedDmFiles" :key="fileId">
                        <span class="file-tag">
                            <span x-text="getLibraryFilename(fileId)"></span>
                            <span class="remove" @click="toggleDmFile(fileId)">&times;</span>
                        </span>
                    </template>
                </div>
                <div x-show="selectedDmFiles.length === 0" style="color: #999; font-size: 13px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤—ã—à–µ (—á–µ–∫–±–æ–∫—Å + Shift –¥–ª—è –õ–°)
                </div>
                <div style="margin-top: 0.5rem;">
                    <select @change="if($event.target.value) { toggleDmFile($event.target.value); $event.target.value=''; }">
                        <option value="">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</option>
                        <template x-for="file in library" :key="file.id">
                            <option :value="file.id" x-text="file.filename" :disabled="selectedDmFiles.includes(file.id)"></option>
                        </template>
                    </select>
                </div>
            </div>
            <button class="btn-primary" @click="sendDirectMessage()" :disabled="!directMessage.message || !directMessage.telegramId || sending">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                        <th>–ì—Ä—É–ø–ø–∞</th>
                        <th>–§–∞–π–ª—ã</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="loading">
                        <tr>
                            <td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                        </tr>
                    </template>
                    <template x-if="!loading && notifications.length === 0">
                        <tr>
                            <td colspan="6" style="text-align: center;">–ù–µ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫</td>
                        </tr>
                    </template>
                    <template x-for="n in notifications" :key="n.id">
                        <tr>
                            <td x-text="formatDate(n.created_at)"></td>
                            <td class="message-preview" :title="n.message" x-text="truncate(n.message, 50)"></td>
                            <td x-text="n.group || '–í—Å–µ'"></td>
                            <td x-text="n.attachments ? n.attachments.length : 0"></td>
                            <td>
                                <span class="status-badge" :class="n.status" x-text="getStatusText(n.status)"></span>
                            </td>
                            <td x-text="n.sent_count + ' / ' + (n.sent_count + n.error_count)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function broadcastsApp() {
            return {
                notifications: [],
                library: [],
                loading: false,
                sending: false,
                stats: { pending: 0, sent: 0, failed: 0 },
                attachTab: 'library',
                selectedLibraryFiles: [],
                newBroadcast: {
                    message: '',
                    group: '',
                    files: []
                },
                editModal: {
                    show: false,
                    id: null,
                    filename: ''
                },
                directMessage: {
                    telegramId: '',
                    message: ''
                },
                selectedDmFiles: [],

                async init() {
                    const token = localStorage.getItem('admin_token');
                    if (!token) {
                        window.location.href = 'login.html';
                        return;
                    }
                    await Promise.all([this.loadNotifications(), this.loadLibrary()]);
                },

                async loadNotifications() {
                    this.loading = true;
                    try {
                        const token = localStorage.getItem('admin_token');
                        const resp = await fetch('/api/admin/notifications', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (resp.status === 401) {
                            window.location.href = 'login.html';
                            return;
                        }

                        const data = await resp.json();
                        this.notifications = data.notifications || [];

                        this.stats = { pending: 0, sent: 0, failed: 0 };
                        for (const n of this.notifications) {
                            if (n.status === 'pending') this.stats.pending++;
                            else if (n.status === 'sent') this.stats.sent++;
                            else if (n.status === 'failed') this.stats.failed++;
                        }
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadLibrary() {
                    try {
                        const token = localStorage.getItem('admin_token');
                        const resp = await fetch('/api/admin/attachments', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await resp.json();
                        this.library = data.attachments || [];
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:', err);
                    }
                },

                async uploadToLibrary(event) {
                    const files = Array.from(event.target.files);
                    const token = localStorage.getItem('admin_token');

                    for (const file of files) {
                        const formData = new FormData();
                        formData.append('file', file);

                        try {
                            await fetch('/api/admin/attachments', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
                        }
                    }

                    event.target.value = '';
                    await this.loadLibrary();
                },

                toggleLibraryFile(fileId) {
                    const idx = this.selectedLibraryFiles.indexOf(fileId);
                    if (idx === -1) {
                        this.selectedLibraryFiles.push(fileId);
                    } else {
                        this.selectedLibraryFiles.splice(idx, 1);
                    }
                },

                getLibraryFilename(fileId) {
                    const file = this.library.find(f => f.id === fileId);
                    return file ? file.filename : 'Unknown';
                },

                toggleDmFile(fileId) {
                    const idx = this.selectedDmFiles.indexOf(fileId);
                    if (idx === -1) {
                        this.selectedDmFiles.push(fileId);
                    } else {
                        this.selectedDmFiles.splice(idx, 1);
                    }
                },

                async sendDirectMessage() {
                    if (!this.directMessage.message || !this.directMessage.telegramId) {
                        alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                        return;
                    }

                    const telegramId = parseInt(this.directMessage.telegramId, 10);
                    if (isNaN(telegramId)) {
                        alert('Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º');
                        return;
                    }

                    this.sending = true;
                    try {
                        const token = localStorage.getItem('admin_token');

                        // 1. –°–æ–∑–¥–∞—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID
                        const resp = await fetch('/api/admin/notifications', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: this.directMessage.message,
                                telegram_ids: [telegramId]
                            })
                        });

                        if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');

                        const result = await resp.json();
                        const notificationId = result.notification.id;

                        // 2. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                        for (const fileId of this.selectedDmFiles) {
                            const file = this.library.find(f => f.id === fileId);
                            if (file) {
                                const fileResp = await fetch(`/api/admin/attachments/${fileId}/file`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const blob = await fileResp.blob();
                                const formData = new FormData();
                                formData.append('file', blob, file.filename);

                                await fetch(`/api/admin/notifications/${notificationId}/attachments`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` },
                                    body: formData
                                });
                            }
                        }

                        // 3. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                        this.directMessage = { telegramId: '', message: '' };
                        this.selectedDmFiles = [];
                        await this.loadNotifications();

                        alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞:', err);
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + err.message);
                    } finally {
                        this.sending = false;
                    }
                },

                openEditModal(file) {
                    this.editModal.id = file.id;
                    this.editModal.filename = file.filename;
                    this.editModal.show = true;
                },

                async renameAttachment() {
                    const token = localStorage.getItem('admin_token');
                    try {
                        await fetch(`/api/admin/attachments/${this.editModal.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ filename: this.editModal.filename })
                        });
                        this.editModal.show = false;
                        await this.loadLibrary();
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ' + err.message);
                    }
                },

                async deleteFromLibrary(fileId) {
                    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏?')) return;

                    const token = localStorage.getItem('admin_token');
                    try {
                        await fetch(`/api/admin/attachments/${fileId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        this.selectedLibraryFiles = this.selectedLibraryFiles.filter(id => id !== fileId);
                        await this.loadLibrary();
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
                    }
                },

                handleFiles(event) {
                    const files = Array.from(event.target.files);
                    this.newBroadcast.files = [...this.newBroadcast.files, ...files];
                },

                removeFile(index) {
                    this.newBroadcast.files.splice(index, 1);
                },

                async createBroadcast() {
                    if (!this.newBroadcast.message) {
                        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                        return;
                    }

                    this.sending = true;
                    try {
                        const token = localStorage.getItem('admin_token');

                        // 1. –°–æ–∑–¥–∞—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        const resp = await fetch('/api/admin/notifications', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: this.newBroadcast.message,
                                group: this.newBroadcast.group
                            })
                        });

                        if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');

                        const result = await resp.json();
                        const notificationId = result.notification.id;

                        // 2. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ –ø–∞–ø–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        for (const fileId of this.selectedLibraryFiles) {
                            const file = this.library.find(f => f.id === fileId);
                            if (file) {
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º
                                const fileResp = await fetch(`/api/admin/attachments/${fileId}/file`, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const blob = await fileResp.blob();
                                const formData = new FormData();
                                formData.append('file', blob, file.filename);

                                await fetch(`/api/admin/notifications/${notificationId}/attachments`, {
                                    method: 'POST',
                                    headers: { 'Authorization': `Bearer ${token}` },
                                    body: formData
                                });
                            }
                        }

                        // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
                        for (const file of this.newBroadcast.files) {
                            const formData = new FormData();
                            formData.append('file', file);

                            await fetch(`/api/admin/notifications/${notificationId}/attachments`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` },
                                body: formData
                            });
                        }

                        // 4. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                        this.newBroadcast = { message: '', group: '', files: [] };
                        this.selectedLibraryFiles = [];
                        await this.loadNotifications();

                        alert('–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞:', err);
                        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏: ' + err.message);
                    } finally {
                        this.sending = false;
                    }
                },

                isImage(mimeType) {
                    return mimeType && mimeType.startsWith('image/');
                },

                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                truncate(str, length) {
                    if (!str) return '';
                    if (str.length <= length) return str;
                    return str.substring(0, length) + '...';
                },

                getStatusText(status) {
                    switch (status) {
                        case 'pending': return '–û–∂–∏–¥–∞–µ—Ç';
                        case 'sent': return '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                        case 'failed': return '–û—à–∏–±–∫–∞';
                        default: return status;
                    }
                },

                logout() {
                    localStorage.removeItem('admin_token');
                    localStorage.removeItem('token_expires');
                    document.cookie = 'admin_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = 'login.html';
                }
            }
        }
    </script>
</body>

</html>
