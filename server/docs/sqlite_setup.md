# Настройка SQLite для системы лояльности

SQLite - это легковесная встраиваемая база данных, которая не требует отдельного сервера. Она хранит все данные в одном файле, что делает её идеальной для небольших приложений и разработки.

## Преимущества SQLite

1. **Простота настройки** - не требует установки и настройки отдельного сервера базы данных
2. **Портативность** - вся база данных хранится в одном файле
3. **Надежность** - транзакционная ACID-совместимая база данных
4. **Нулевая конфигурация** - не требует администрирования

## Настройка сервера для работы с SQLite

1. Отредактируйте файл `server/cmd/loyalityserver/config.yaml`, чтобы использовать SQLite:

```yaml
storage:
  # Тип хранилища: "file", "postgres", "sqlite"
  type: "sqlite"

  # Параметры для SQLite
  db_path: "/Users/goomer125/Documents/sirius-rating-system/server/cmd/loyalityserver/data/loyality_system.db"
  migrations_path: "/Users/goomer125/Documents/sirius-rating-system/server/migrations/sqlite"
```

Параметры:

- `type` - тип хранилища, должен быть "sqlite"
- `db_path` - путь к файлу базы данных SQLite (будет создан автоматически, если не существует)
- `migrations_path` - путь к миграциям SQLite

2. Запустите сервер:

```bash
cd server
go run cmd/loyalityserver/main.go
```

## Миграции

### Как работают миграции

Миграции в нашей системе используют библиотеку `golang-migrate/migrate`. Они работают следующим образом:

1. **Миграции "up"** (файлы `.up.sql`) применяются автоматически при запуске сервера, если они еще не были применены. Они создают или изменяют структуру базы данных.

2. **Миграции "down"** (файлы `.down.sql`) используются только для ручного отката миграций, если это необходимо. Они **не выполняются автоматически при закрытии сервера**. Таблицы не удаляются при остановке сервера.

3. Библиотека миграций отслеживает, какие миграции уже были применены, в специальной таблице `schema_migrations` в базе данных. Это гарантирует, что каждая миграция применяется только один раз.

### Создание новых миграций

Если вы хотите добавить новую миграцию, создайте файлы в формате:

```
server/migrations/sqlite/000002_название_миграции.up.sql
server/migrations/sqlite/000002_название_миграции.down.sql
```

Где:

- `000002` - порядковый номер миграции (увеличивается на 1 для каждой новой миграции)
- `название_миграции` - краткое описание изменений
- `.up.sql` - SQL-запросы для применения миграции (создание/изменение таблиц)
- `.down.sql` - SQL-запросы для отката миграции (используются только при ручном откате)

## Просмотр и редактирование базы данных SQLite

Для просмотра и редактирования базы данных SQLite можно использовать различные инструменты:

1. **SQLite CLI** - командная строка SQLite:

```bash
sqlite3 /path/to/loyality_system.db
```

2. **DB Browser for SQLite** - графический интерфейс для работы с SQLite:
   - Скачайте и установите с [официального сайта](https://sqlitebrowser.org/)
   - Откройте файл базы данных через меню "Открыть базу данных"

3. **VSCode с расширением SQLite** - для просмотра базы данных прямо в редакторе:
   - Установите расширение "SQLite" от alexcvzz
   - Используйте команду "SQLite: Open Database" и выберите файл базы данных

## Проверка работы

После запуска сервера, вы можете проверить, что таблицы были созданы в базе данных:

```bash
sqlite3 /path/to/loyality_system.db ".tables"
```

Вы должны увидеть список таблиц: `users`, `transactions`, `codes`, `code_usages` и `schema_migrations`.

Для просмотра содержимого таблицы:

```bash
sqlite3 /path/to/loyality_system.db "SELECT * FROM users;"
```
