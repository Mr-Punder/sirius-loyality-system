# Telegram-боты для системы лояльности

В этой директории находятся два Telegram-бота для системы лояльности:

1. **Пользовательский бот** - для участников программы лояльности
2. **Административный бот** - для администраторов системы

## Пользовательский бот

Пользовательский бот позволяет участникам программы лояльности:

- Регистрироваться в системе
- Просматривать свои баллы
- Добавлять баллы через QR-код

### Запуск пользовательского бота

```bash
cd server
go run cmd/telegrambot/user/main.go
```

Перед запуском необходимо поместить токен бота в файл `cmd/telegrambot/user/token.txt`.

Параметры запуска:

- `-token-file` - путь к файлу с токеном бота (по умолчанию cmd/telegrambot/user/token.txt)
- `-token` - токен бота, полученный от @BotFather (устаревший способ, используйте файл token.txt)
- `-server` - URL сервера API (по умолчанию <http://localhost:8080>)
- `-c` - путь к конфигурационному файлу (по умолчанию cmd/loyalityserver/config.yaml)

### Команды пользовательского бота

- `/start` - начать работу с ботом
- `/register` - зарегистрироваться в системе
- `/points` - просмотреть свои баллы

Для регистрации пользователь должен отправить свои данные в формате: `Имя Фамилия Группа`

Для применения QR-кода пользователь должен отправить боту UUID кода.

## Административный бот

Административный бот позволяет администраторам системы:

- Просматривать список всех участников программы
- Просматривать информацию о конкретном участнике
- Добавлять баллы участникам
- Генерировать QR-коды для добавления баллов

### Запуск административного бота

```bash
cd server
go run cmd/telegrambot/admin/main.go
```

Перед запуском необходимо поместить токен бота в файл `cmd/telegrambot/admin/token.txt`.

Параметры запуска:

- `-token-file` - путь к файлу с токеном бота (по умолчанию cmd/telegrambot/admin/token.txt)
- `-token` - токен бота, полученный от @BotFather (устаревший способ, используйте файл token.txt)
- `-admin` - ID администратора в Telegram (необязательный, используется только при первом запуске, если файл с администраторами не существует)
- `-server` - URL сервера API (по умолчанию <http://localhost:8080>)
- `-c` - путь к конфигурационному файлу (по умолчанию cmd/loyalityserver/config.yaml)

### Команды административного бота

- `/start` - начать работу с ботом
- `/users [группа]` - получить список всех пользователей (опционально фильтр по группе)
- `/user <ID>` - получить информацию о конкретном пользователе
- `/addpoints <ID> <баллы>` - добавить баллы пользователю
- `/generatecode <баллы> [перПользователя] [всего] [группа]` - сгенерировать QR-код
- `/addadmin <ID>` - добавить нового администратора
- `/listadmins` - показать список администраторов
- `/help` - показать справку

## Получение токена бота

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания нового бота
4. После создания бота вы получите токен
5. Сохраните токен в файл:
   - Для пользовательского бота: `cmd/telegrambot/user/token.txt`
   - Для административного бота: `cmd/telegrambot/admin/token.txt`

## Получение ID пользователя в Telegram

1. Откройте Telegram и найдите @userinfobot
2. Отправьте любое сообщение
3. Бот ответит вам вашим ID в Telegram

## Примечания

- Для работы ботов необходимо, чтобы сервер системы лояльности был запущен
- Пользовательский и административный боты должны иметь разные токены
- Доступ к административному боту имеют только пользователи, указанные в списке администраторов
- При первом запуске, если файл с администраторами не существует и указан параметр `-admin`, пользователь с этим ID автоматически добавляется в список администраторов
- Если при первом запуске не указан параметр `-admin` и файл с администраторами не существует, список администраторов будет пустым, и вам нужно будет добавить администраторов через веб-интерфейс
- Список администраторов хранится в файле `cmd/telegrambot/admin/admins.json`
- Группы пользователей должны быть в формате Н1-Н6 (поддерживается ввод в разных регистрах и раскладках: Н1, н1, H1, h1)
