# Статус проекта Sirius Rating System

## Общее описание

Проект представляет собой систему лояльности, которая позволяет пользователям накапливать баллы через применение QR-кодов. Система поддерживает различные ограничения на использование кодов, такие как ограничение на количество использований одним пользователем, общее количество использований кода и принадлежность пользователя к определенной группе.

## Реализованные компоненты

### Модели данных (models.go)

- **User**: Модель пользователя с полями для идентификации, личной информации, баллов, группы и статуса удаления.
- **Transaction**: Модель транзакции для отслеживания изменений баллов пользователя.
- **Code**: Модель QR-кода с ограничениями на использование (per_user, total), принадлежностью к группе и статусом активности.
- **CodeUsage**: Модель использования кода пользователем, отслеживающая количество использований.

### Хранилища данных

- **Интерфейс Storage**: Определяет методы для работы с данными (получение, добавление, обновление, удаление).
- **Memstorage**: Реализация хранилища в памяти с использованием sync.Map.
- **Filestorage**: Реализация хранилища с сохранением данных в JSON-файлы.

### Обработчики HTTP (handlers.go)

- Регистрация пользователей
- Создание и применение QR-кодов
- Получение информации о пользователях и их транзакциях
- Обновление и удаление пользователей и кодов

### Конфигурация (config.go)

- Загрузка конфигурации из YAML-файла
- Поддержка переопределения параметров через флаги командной строки
- Настройка сервера, логирования и хранилища данных

### Middleware

- Сжатие ответов с использованием gzip
- Логирование HTTP-запросов

### Логирование

- Интерфейс Logger для абстракции логирования
- Реализация на основе zap-логгера

### Тесты

- Тесты для хранилища данных (filestorage_test.go)
- Тесты для обработчиков HTTP (handlers_test.go)
- Тесты для middleware (gzipcompressor_test.go)

## Последние изменения

1. Добавлена поддержка групп пользователей в модели User и Code.
2. Реализовано файловое хранилище (Filestorage) для сохранения данных в JSON-файлы.
3. Добавлена проверка принадлежности пользователя к группе при применении кода.
4. Изменен порядок проверок в методе AddCodeUsage для корректной обработки ошибок.
5. Обновлены тесты для проверки новой функциональности.
6. Изменено значение флага по умолчанию для пути к конфигурационному файлу.
7. Реализован веб-интерфейс администратора с аутентификацией и управлением пользователями и QR-кодами.
8. Добавлена поддержка JWT-токенов для аутентификации администратора.
9. Реализована фильтрация пользователей по году регистрации и группе.
10. Добавлена возможность редактирования данных пользователей через веб-интерфейс.
11. Реализована генерация QR-кодов с настраиваемыми параметрами.
12. Добавлена защита API с помощью токена (middleware token_auth.go).
13. Реализована проверка токена API для всех запросов к API (кроме административных).
14. Исправлена проблема с обработкой команд с параметрами в боте администратора.
15. Улучшена обработка состояний в боте администратора для корректной работы с параметрами.

## Текущее состояние

- Сервер запускается и работает с файловым хранилищем.
- Все тесты проходят успешно.
- Данные сохраняются в файлы в директории, указанной в конфигурации.
- Веб-интерфейс администратора доступен по адресу <http://127.0.0.1:8080/admin/>
- Пароль администратора генерируется автоматически при первом входе и сохраняется в файле.

## Планы на будущее

1. Добавить поддержку SQLite в качестве альтернативного хранилища данных.
2. Реализовать аутентификацию и авторизацию пользователей.
3. Добавить API для администрирования системы.
4. Разработать веб-интерфейс для управления системой (в процессе).
5. Добавить поддержку уведомлений пользователей.
6. Интегрировать генерацию QR-кодов в виде изображений в Telegram-ботах.

## Текущие разработки

### Telegram-боты

Реализованы два Telegram-бота для взаимодействия с системой:

1. **Пользовательский бот** - для участников программы лояльности:
   - Регистрация в системе
   - Просмотр баллов
   - Применение QR-кодов

2. **Административный бот** - для администраторов системы:
   - Просмотр списка пользователей (с фильтрацией по группе)
   - Просмотр информации о конкретном пользователе
   - Добавление баллов пользователям
   - Генерация QR-кодов с настраиваемыми параметрами

Подробная документация по ботам доступна в [README.md](server/cmd/telegrambot/README.md).

### Веб-интерфейс администратора

### Требования к веб-интерфейсу

1. **Аутентификация**:
   - При входе требуется ввод пароля, который хранится в виде хеша в отдельном файле
   - Сессионная аутентификация (не требует повторного ввода пароля при обновлении страницы)
   - Автоматический выход после длительного периода неактивности

2. **Интерфейс**:
   - Таблица со всеми пользователями и их данными
   - Фильтр по году регистрации (по умолчанию текущий год, возможность выбора из последних 6 лет)
   - Фильтр по группе (Н1-Н6, по умолчанию не применяется)
   - Сортировка по всем колонкам таблицы
   - Возможность редактирования данных прямо в ячейках таблицы
   - Страница для генерации QR-кодов с настраиваемыми параметрами

### Технологический стек

1. **Бэкенд**: Go (расширение существующего сервера)
2. **Фронтенд**: HTML, CSS и JavaScript с использованием Alpine.js для реактивности
3. **Аутентификация**: JWT (JSON Web Tokens) для сессионного управления
4. **Хранение пароля**: bcrypt для хеширования пароля

### План реализации

1. **Серверная часть**:
   - Модуль для работы с паролями (хеширование, проверка)
   - Модуль для работы с JWT (генерация, валидация)
   - Middleware для проверки JWT-токена
   - Обработчики для новых эндпоинтов админки

2. **Клиентская часть**:
   - Страница входа с формой аутентификации
   - Основная страница с таблицей пользователей
   - Функционал фильтрации и сортировки
   - Функционал редактирования данных
   - Страница генерации QR-кодов

### Структура файлов

```
server/
├── internal/
│   ├── admin/
│   │   ├── auth.go         # Аутентификация и JWT
│   │   ├── handlers.go     # Обработчики для админки
│   │   ├── middleware.go   # Middleware для проверки JWT
│   │   └── password.go     # Работа с паролями
│   └── ...
├── static/
│   ├── admin/
│   │   ├── css/
│   │   │   └── styles.css
│   │   ├── js/
│   │   │   ├── auth.js     # Логика аутентификации
│   │   │   ├── table.js    # Логика работы с таблицей
│   │   │   └── codes.js    # Логика генерации QR-кодов
│   │   ├── login.html      # Страница входа
│   │   ├── users.html      # Страница с таблицей пользователей
│   │   └── codes.html      # Страница генерации QR-кодов
│   └── ...
└── ...
```

## Структура проекта

```
server/
├── cmd/
│   └── loyalityserver/
│       ├── config.yaml      # Конфигурационный файл
│       ├── main.go          # Точка входа в приложение
│       ├── data/            # Директория для хранения данных
│       └── logs/            # Директория для логов
├── internal/
│   ├── config/              # Конфигурация приложения
│   ├── gzipcomp/            # Компрессия ответов
│   ├── handlers/            # HTTP-обработчики
│   ├── logger/              # Логирование
│   ├── loyalityserver/      # Основной сервер
│   ├── middleware/          # Промежуточное ПО
│   ├── models/              # Модели данных
│   ├── server/              # HTTP-сервер
│   └── storage/             # Хранилища данных
│       ├── memstorage.go    # Хранилище в памяти
│       ├── filestorage.go   # Файловое хранилище
│       ├── storage.go       # Интерфейс хранилища
│       └── tests/           # Тесты для хранилищ
```

## Как запустить

```bash
cd server
go run cmd/loyalityserver/main.go
```

Сервер будет доступен по адресу, указанному в конфигурационном файле (по умолчанию <http://127.0.0.1:8080>).

## Как запустить тесты

```bash
cd server
go test ./...
```
